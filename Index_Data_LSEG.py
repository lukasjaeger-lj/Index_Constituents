# ===============================================================# Author(s)     : Lukas Jaeger# Institution   : University of Bern#                 Institution for Financial Management# ==============================================================="""Note:This code builds on the framework from Aramyan (2025).https://developers.lseg.com/en/article-catalog/article/building-historical-index-constituentsIn order to run the code:  1) Open Refinitiv Workspace;  2) Generate an API app key to insert in line 46 (Refinitiv Workspace > Search "App Key Generator"))  3) Define your universe:          - Country of choice in line 50 (e.g., Switzerland)          - Index of choice in line 51 (e.g., SPI)          - Index in line 52 (e.g., SSHI - correct abbreviation can be found in Refinitiv Workspace);  4) Enter timeframe of investigation in format YYYY-MM-DD in line 55 (start) and 56 (end);  5) Set your own directory in line 59;  6) Add variables of your choice in line 191 (Refinitiv Workspace > Search "Data Item Browser");  7) Run the code (if you have not yet installed the API, use pip install lseg-data).Saved output in folder:    - index_constituents_(...): This dataframe includes all firms that have been included in the                                index within the defined time window.    - index_constituents_joiners_leavers_(...): This dataframe includes all firms joining or leaving                                                the index within the defined time window.    - index_ts_data_(...): This dataframe represents the historical time-series data (e.g., prices)                           for all index constituents over the defined time window.                                       Please report any irregularities to Lukas Jaeger (lukas.jaeger@unibe.ch)."""# ===============================================================# Preparations# ===============================================================# Import packagesimport lseg.data as ldimport pandas as pdimport copyimport os# Open LSEG SessionAPP_KEY = "YOUR_APP_KEY"ld.open_session(app_key=APP_KEY)# Define universecountry_of_choice = "COUNTRY_OF_CHOICE"index_of_choice = "INDEX_OF_CHOICE"index = "LSEG_INDEX_RIC"# Define start and end Datestart = 'START_DATE'end = 'END_DATE'# Define directory (and create folder if not yet exists)save_dir = f"YOUR_WORKING_DIRECTORY/{country_of_choice}"os.makedirs(save_dir, exist_ok=True)# ===============================================================# Define set of functions# ===============================================================class IndexConstituents:    def get_historical_constituents(self, index, start, end):        initial_constituents = self.get_constituents_as_of(index, start)        constituent_changes = self.get_constituent_changes(index, start, end)        historical_constituents = self.update_constituents(start, initial_constituents, constituent_changes)        return historical_constituents    def get_constituents_as_of(self, ric, date):        initial_constituents = ld.get_data(universe=[f"0#{ric}({date.replace('-', '')})"],                     fields=["TR.PriceClose"],                    parameters={"SDATE":f"{date}", "EDATE":f"{date}"}                )        initial_constituents = initial_constituents['Instrument'].to_list()        return initial_constituents        def get_constituent_changes(self, ric, start, end):        const_changes  = ld.get_data(universe=[ric],                     fields = ["TR.IndexJLConstituentChangeDate", "TR.IndexJLConstituentRIC",                            "TR.IndexJLConstituentName", "TR.IndexJLConstituentituentChange"],                    parameters={"SDATE":f"{start}","EDATE":f"{end}", 'IC':'B'}                )        return const_changes    def update_constituents(self, start, constituents, constitent_changes):        hist_constituents = pd.DataFrame([(start, ric) for ric in constituents], columns=['Date', 'RIC'])        for date in constitent_changes['Date'].unique():            const_changes_date = constitent_changes[constitent_changes['Date'] == date]            joiners = const_changes_date[const_changes_date['Change']=='Joiner']['Constituent RIC'].to_list()            leavers = const_changes_date[const_changes_date['Change']=='Leaver']['Constituent RIC'].to_list()            joiners_unique = list(set(joiners) - set(leavers))            leavers_unique = list(set(leavers) - set(joiners))            if len(joiners_unique) > 0:                constituents = self.add_joiner(constituents, joiners_unique)            if len(leavers_unique) > 0:                constituents = self.remove_leaver(constituents, leavers_unique)            new_constituents = copy.deepcopy(constituents)            new_constituents_df =  pd.DataFrame([(str(date)[:10], ric) for ric in new_constituents], columns=['Date', 'RIC'])            hist_constituents = pd.concat([hist_constituents, new_constituents_df])        hist_constituents = hist_constituents.reset_index(drop = True)        return hist_constituents        def add_joiner(self, init_list, joiner_list):        for joiner in joiner_list:            if joiner not in init_list:                init_list.append(joiner)            else:                print(f'{joiner} joiner is already in the list')        return init_list    def remove_leaver(self, init_list, leaver_list):        for leaver in leaver_list:            if leaver in init_list:                init_list.remove(leaver)            else:                print(f'{leaver} leaver is not in the list')        return init_listdef const_within_time(historical_constituents, const_changes):    chg = const_changes.copy()    rename_map = {}    for c in chg.columns:        lc = c.lower()        if 'date' in lc:            rename_map[c] = 'Date'        if 'constituent' in lc and 'ric' in lc:            rename_map[c] = 'Constituent RIC'        if 'change' in lc:            rename_map[c] = 'Change'        if 'constituent' in lc and 'name' in lc:            rename_map[c] = 'Constituent Name'    if rename_map:        chg = chg.rename(columns=rename_map)    ric_hist = pd.Series(historical_constituents['RIC'], dtype=str).dropna().unique().tolist()    if 'Constituent RIC' in chg.columns:        ric_changes = pd.Series(chg['Constituent RIC'], dtype=str).dropna().unique().tolist()    else:        ric_changes = []    all_rics = sorted(set(ric_hist) | set(ric_changes))    const_of_index = pd.DataFrame({'RIC': all_rics})    return const_of_indexdef add_constituent_id(const_of_index):    df = const_of_index.copy()    rics = df['RIC'].dropna().astype(str).unique().tolist()    rics.remove('')     names = ld.get_data(        universe=rics,        fields=["TR.CompanyName", "TR.OrganizationID"],        parameters={}    )    const_of_index_incl_dupl = df.merge(        names[['Instrument', 'Company Name', 'Organization PermID']],        left_on='RIC', right_on='Instrument',        how='left'    ).drop(columns=['Instrument'])    return const_of_index_incl_dupldef drop_duplicates_by_orgid(const_of_index_incl_dupl):    df = const_of_index_incl_dupl.copy()    df = df.sort_values('RIC')    if 'Organization PermID' in df.columns:        df = df.drop_duplicates(subset=['Organization PermID'], keep='first')    index_constituents = df.reset_index(drop=True)    return index_constituentsdef save_joiners_leavers(const_changes, country_of_choice, index_of_choice, save_dir, start, end):    filename = f"index_constituents_joiners_leavers_{country_of_choice}_{index_of_choice}_{start}_{end}.csv"    path = os.path.join(save_dir, filename)    const_changes.to_csv(path, index=False)    print(f"Saved to: {path}")def save_index_constituents(index_constituents, country_of_choice, index_of_choice, save_dir, start, end):    filename = f"index_constituents_{country_of_choice}_{index_of_choice}_{start}_{end}.csv"    path = os.path.join(save_dir, filename)    index_constituents.to_csv(path, index=False)    print(f"Saved to: {path}")def get_ts_data(index_constituents, start, end):    rics = index_constituents['RIC'].dropna().astype(str).unique().tolist()    rics.remove('')     index_ts_data = ld.get_data(        universe=rics,        fields=["TR.PriceClose.date", "TR.CompanyName", "TR.PriceClose"],        parameters={"SDate": start, "EDate": end}    )    index_ts_data = index_ts_data.dropna(subset=["Date"])    index_ts_data["Date"] = pd.to_datetime(index_ts_data["Date"])    index_ts_data = index_ts_data[(index_ts_data["Date"] >= pd.to_datetime(start)) &                                  (index_ts_data["Date"] <= pd.to_datetime(end))]    name_col = "Company Name" if "Company Name" in index_ts_data.columns else ("TR.CompanyName" if "TR.CompanyName" in index_ts_data.columns else None)    if name_col is not None and "Instrument" in index_ts_data.columns:        index_ts_data[name_col] = index_ts_data[name_col].replace("", pd.NA)        index_ts_data = index_ts_data.sort_values(["Instrument", "Date"])        index_ts_data[name_col] = index_ts_data.groupby("Instrument")[name_col].transform(lambda s: s.ffill().bfill())    index_ts_data = index_ts_data.rename(columns={"Instrument": "RIC"})    return index_ts_datadef save_ts_data(index_ts_data, country_of_choice, index_of_choice, save_dir,  start, end):    filename = f"index_ts_data_{country_of_choice}_{index_of_choice}_{start}_{end}.csv"    path = os.path.join(save_dir, filename)    index_ts_data.to_csv(path, index=False)    print(f"Saved to: {path}")# ===============================================================# Call functions# ===============================================================# Create instance of IndexConstituents class to access its methodsic = IndexConstituents()# Call historical constituentshistorical_constituents = ic.get_historical_constituents(index, start, end)# Call joiners and leavers and saveconst_changes = ic.get_constituent_changes(index, start, end)save_joiners_leavers(const_changes, country_of_choice, index_of_choice, save_dir, start, end)# Get all constituents within time and saveconst_of_index = const_within_time(historical_constituents, const_changes)const_of_index_incl_dupl = add_constituent_id(const_of_index)index_constituents = drop_duplicates_by_orgid(const_of_index_incl_dupl)save_index_constituents(index_constituents, country_of_choice, index_of_choice, save_dir, start, end)# Get time series data and saveindex_ts_data = get_ts_data(index_constituents, start, end)save_ts_data(index_ts_data, country_of_choice, index_of_choice, save_dir,  start, end)# ===============================================================# END# ===============================================================ld.close_session()